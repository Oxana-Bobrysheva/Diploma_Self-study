{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center">
                <h1 class="display-4 mb-3">Каталог Курсов</h1>
                <p class="lead">Изучайте, развивайтесь, достигайте новых высот</p>
            </div>
        </div>
    </div>

    <!-- Platform Statistics Banner -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card stats-card">
                <div class="card-body py-4">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-book fa-2x text-success mb-2"></i>
                                <h3 class="text-success mb-1">{{ total_courses }}</h3>
                                <p class="mb-0 text-muted small">Курсов на платформе</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                                <h3 class="text-primary mb-1">{{ total_materials }}</h3>
                                <p class="mb-0 text-muted small">Учебных материалов</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-question-circle fa-2x text-info mb-2"></i>
                                <h3 class="text-info mb-1">{{ total_tests }}</h3>
                                <p class="mb-0 text-muted small">Проверочных тестов</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-chalkboard-teacher fa-2x text-warning mb-2"></i>
                                <h3 class="text-warning mb-1">{{ total_teachers }}</h3>
                                <p class="mb-0 text-muted small">Преподавателей</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <form method="get" class="d-flex">
                <div class="input-group">
                    <input type="text"
                           name="search"
                           class="form-control"
                           placeholder="Найти курс по названию или описанию..."
                           value="{{ search_query }}"
                           style="border-radius: 25px 0 0 25px;">
                    <button type="submit" class="btn btn-custom" style="border-radius: 0 25px 25px 0;">
                        <i class="fas fa-search me-2"></i>Найти
                    </button>
                </div>
            </form>
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex justify-content-end align-items-center h-100">
                <span class="badge bg-light text-dark fs-6">
                    <i class="fas fa-filter me-1"></i>Найдено: {{ courses.count }} курсов
                </span>
            </div>
        </div>
    </div>

    <!-- Info Alert for Unauthenticated Users -->
    {% if not user_is_authenticated %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3"></i>
                    <div>
                        <strong>Получите полный доступ!</strong> Войдите в систему, чтобы просматривать детали курсов,
                        записываться на обучение и получить доступ ко всем материалам.
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Courses Grid (keep your existing courses grid code) -->
    <div class="row">
        {% for course in courses %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card stats-card h-100 course-card">
                <!-- Course Image -->
                {% if course.preview %}
                <img src="{{ course.preview.url }}"
                     class="card-img-top"
                     alt="{{ course.title }}"
                     style="height: 200px; object-fit: cover;">
                {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                     style="height: 200px;">
                    <i class="fas fa-book-open fa-3x text-muted"></i>
                </div>
                {% endif %}

                <!-- Course Body -->
                <div class="card-body d-flex flex-column">
                    <!-- Course Title -->
                    <h5 class="card-title text-dark">{{ course.title }}</h5>

                    <!-- Author Info (only for authenticated users) -->
                    {% if user_is_authenticated %}
                    <div class="d-flex align-items-center mb-2">
                        {% if course.owner.avatar %}
                        <img src="{{ course.owner.avatar.url }}"
                             alt="{{ course.owner.name }}"
                             class="rounded-circle me-2"
                             width="30" height="30" style="object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2"
                             style="width: 30px; height: 30px;">
                            <span class="text-white small">{{ course.owner.name|first|upper }}</span>
                        </div>
                        {% endif %}
                        <small class="text-muted">
                            {% if course.owner.name %}
                                {{ course.owner.name }}
                            {% else %}
                                {{ course.owner.email }}
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}

                    <!-- Course Description (limited to 5 lines for everyone) -->
                    <div class="course-description mb-3" style="
                        display: -webkit-box;
                        -webkit-line-clamp: 5;
                        -webkit-box-orient: vertical;
                        overflow: hidden;
                        height: 7.5em;
                    ">
                        <p class="card-text text-muted mb-0">
                            {{ course.description|default:"Описание пока не добавлено..." }}
                        </p>
                    </div>

                    <!-- Course-specific Statistics (visible to everyone) -->
                    <div class="course-stats mb-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-success">
                                    <i class="fas fa-file-alt me-1"></i><br>
                                    {{ course.materials_count }} материалов
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="text-primary">
                                    <i class="fas fa-question-circle me-1"></i><br>
                                    {{ course.tests_count }} тестов
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="mt-auto">
                        {% if user_is_authenticated %}
                        <!-- Authenticated users see full details button -->
                        <a href="{% url 'course-detail' course.id %}"
                           class="btn btn-custom w-100">
                            <i class="fas fa-eye me-1"></i>Подробнее
                        </a>
                        {% else %}
                        <!-- Unauthenticated users see login prompt button -->
                        <button type="button"
                                class="btn btn-outline-success w-100"
                                data-bs-toggle="modal"
                                data-bs-target="#loginRequiredModal"
                                data-course-title="{{ course.title }}">
                            <i class="fas fa-info-circle me-1"></i>Подробнее
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Course Footer -->
                <div class="card-footer bg-transparent">
                    <small class="text-muted">
                        <i class="far fa-clock me-1"></i>
                        Создан {{ course.created_at|date:"d.m.Y" }}
                    </small>
                </div>
            </div>
        </div>
        {% empty %}
        <!-- Empty state code remains the same -->
        {% endfor %}
    </div>

    <!-- Keep the login modal and styles -->
</div>

<!-- Login Required Modal -->
<div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-labelledby="loginRequiredModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginRequiredModalLabel">Требуется авторизация</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Для просмотра подробной информации о курсе "<span id="modalCourseTitle"></span>" необходимо войти в систему.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <a href="{% url 'login' %}" class="btn btn-primary">Войти</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}