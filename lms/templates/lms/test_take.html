{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'course_list' %}">Курсы</a></li>
            <li class="breadcrumb-item"><a href="{% url 'course-detail' testing.material.course.id %}">{{ testing.material.course.title }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'material-detail' testing.material.id %}">{{ testing.material.title }}</a></li>
            <li class="breadcrumb-item active">Прохождение теста</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-play-circle me-2"></i>{{ testing.title }}
                    </h4>
                </div>
                <div class="card-body">
                    {% if testing.description %}
                    <div class="alert alert-info">
                        {{ testing.description }}
                    </div>
                    {% endif %}

                    <div class="test-info mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Проходной балл:</strong> {{ testing.passing_score }}%
                            </div>
                            <div class="col-md-6">
                                <strong>Вопросов:</strong> {{ questions.count }}
                            </div>
                        </div>
                        {% if testing.time_limit > 0 %}
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <strong>Лимит времени:</strong> {{ testing.time_limit }} минут
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <form method="post" action="{% url 'test_submit' testing.id %}" id="test-form">
                        {% csrf_token %}

                        {% for question in questions %}
                        <div class="card mb-4 question-card">
                            <div class="card-header">
                                <h5 class="mb-0">Вопрос {{ forloop.counter }}</h5>
                            </div>
                            <div class="card-body">
                                <!-- Question Text -->
                                <div class="mb-3">
                                    <p class="fw-bold">{{ question.text }}</p>
                                </div>

                                <!-- Question Media -->
                                {% if question.image %}
                                <div class="mb-3">
                                    <img src="{{ question.image.url }}" alt="Изображение вопроса" class="img-fluid" style="max-height: 300px;">
                                </div>
                                {% endif %}

                                {% if question.audio %}
                                <div class="mb-3">
                                    <audio controls class="w-100">
                                        <source src="{{ question.audio.url }}" type="audio/mpeg">
                                        Ваш браузер не поддерживает аудио элемент.
                                    </audio>
                                </div>
                                {% endif %}

                                <!-- Answers -->
                                <div class="answers">
                                    {% for answer in question.answers.all %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio"
                                               name="question_{{ question.id }}"
                                               id="answer_{{ answer.id }}"
                                               value="{{ answer.id }}" required>
                                        <label class="form-check-label" for="answer_{{ answer.id }}">
                                            {{ answer.text }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <h5>В тесте пока нет вопросов</h5>
                            <p>Обратитесь к преподавателю для добавления вопросов в тест.</p>
                        </div>
                        {% endfor %}

                        {% if questions %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Завершить тест
                            </button>
                            <div class="form-text mt-2">
                                Проверьте, что ответили на все вопросы перед отправкой
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar with test info -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Информация о тесте</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Материал:</strong><br>
                        {{ testing.material.title }}
                    </div>
                    <div class="mb-3">
                        <strong>Курс:</strong><br>
                        {{ testing.material.course.title }}
                    </div>
                    <div class="mb-3">
                        <strong>Проходной балл:</strong><br>
                        {{ testing.passing_score }}%
                    </div>
                    <div class="mb-3">
                        <strong>Всего вопросов:</strong><br>
                        {{ questions.count }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('test-form');
    const submitBtn = form.querySelector('button[type="submit"]');

    // Validate that all questions are answered before submission
    form.addEventListener('submit', function(e) {
        const unanswered = [];
        const radioGroups = form.querySelectorAll('input[type="radio"]');
        const grouped = {};

        // Group radio buttons by name
        radioGroups.forEach(radio => {
            if (!grouped[radio.name]) {
                grouped[radio.name] = [];
            }
            grouped[radio.name].push(radio);
        });

        // Check if any group has no selection
        Object.keys(grouped).forEach(groupName => {
            const isChecked = grouped[groupName].some(radio => radio.checked);
            if (!isChecked) {
                unanswered.push(groupName);
            }
        });

        if (unanswered.length > 0) {
            e.preventDefault();
            alert(`Пожалуйста, ответьте на все вопросы. Не отвечено: ${unanswered.length} вопросов.`);
        }
    });
});
</script>
{% endblock %}>